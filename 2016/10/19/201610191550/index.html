<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="-kiDoxWZ_ezIUVBSVQQF1juVwZygZ3eS9BM-D33eE34" />







  <meta name="baidu-site-verification" content="IgvSdkD53Z" />







  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Objective-C,Demo,Touch ID," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="原文：iOS指纹识别登录流程及实现  闲谈最近一直在追青云志，总觉得电视剧没有小说来的精彩。是的，大咖们演技堪称惊艳，剧情改编也很紧凑，但不得不说很多东西单靠演是达不到的，主人公每一刻的内心也只能在小说中才能看的贴切（为了装X，哥不惜二百两买了一沓正版典藏版）。">
<meta name="keywords" content="Objective-C,Demo,Touch ID">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS指纹识别登录流程及实现">
<meta property="og:url" content="https://zonghongyan.github.io/2016/10/19/201610191550/index.html">
<meta property="og:site_name" content="仁伯安">
<meta property="og:description" content="原文：iOS指纹识别登录流程及实现  闲谈最近一直在追青云志，总觉得电视剧没有小说来的精彩。是的，大咖们演技堪称惊艳，剧情改编也很紧凑，但不得不说很多东西单靠演是达不到的，主人公每一刻的内心也只能在小说中才能看的贴切（为了装X，哥不惜二百两买了一沓正版典藏版）。">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/949086-e7042f7dcab839f5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/250">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/949086-79e3157a8aa5027d.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/250">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/949086-05026b5044ba62e9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/300">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/949086-dd8751e1eabc6521.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/960">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/949086-1a291c4684c42ac3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/960">
<meta property="og:image" content="http://upload-images.jianshu.io/upload_images/949086-d8e74f9da26c355e.gif?imageMogr2/auto-orient/strip%7CimageView2/2/w/333">
<meta property="og:updated_time" content="2017-07-02T01:39:14.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOS指纹识别登录流程及实现">
<meta name="twitter:description" content="原文：iOS指纹识别登录流程及实现  闲谈最近一直在追青云志，总觉得电视剧没有小说来的精彩。是的，大咖们演技堪称惊艳，剧情改编也很紧凑，但不得不说很多东西单靠演是达不到的，主人公每一刻的内心也只能在小说中才能看的贴切（为了装X，哥不惜二百两买了一沓正版典藏版）。">
<meta name="twitter:image" content="http://upload-images.jianshu.io/upload_images/949086-e7042f7dcab839f5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/250">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"right","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 'undefined',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://zonghongyan.github.io/2016/10/19/201610191550/"/>





  <title>iOS指纹识别登录流程及实现 | 仁伯安</title>
  







  <script type="text/javascript">
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=60821256";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">仁伯安</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description">摒弃诱惑，否极泰来(Get rid of the temptation,After a storm comes a calm)</h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="https://zonghongyan.github.io/2016/10/19/201610191550/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="仁伯安">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar/avatar-60.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="仁伯安">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">iOS指纹识别登录流程及实现</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-10-19T15:50:03+08:00">
                2016-10-19
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS进阶篇/" itemprop="url" rel="index">
                    <span itemprop="name">iOS进阶篇</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i> 本文总阅读量
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>次
            </span>
          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>原文：<a href="http://www.jianshu.com/p/67fd93408517" target="_blank" rel="external">iOS指纹识别登录流程及实现</a></p>
<p><img src="http://upload-images.jianshu.io/upload_images/949086-e7042f7dcab839f5.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/250" alt="指纹.png"></p>
<h3 id="闲谈"><a href="#闲谈" class="headerlink" title="闲谈"></a>闲谈</h3><p>最近一直在追青云志，总觉得电视剧没有小说来的精彩。是的，大咖们演技堪称惊艳，剧情改编也很紧凑，但不得不说很多东西单靠演是达不到的，主人公每一刻的内心也只能在小说中才能看的贴切（为了装X，哥不惜二百两买了一沓正版典藏版）。<a id="more"></a></p>
<p><img src="http://upload-images.jianshu.io/upload_images/949086-79e3157a8aa5027d.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/250" alt=""></p>
<p>看过的童鞋知道，张小凡手中的法宝，是由摄魂与嗜血珠以张小凡精血为媒淬炼而成。而且此法宝，有一特大优秀品质，那就是除了与张小凡有血缘关系的人之外，即便你有通天本领也不能操控，忠诚如此夫复何求啊，说到这里大概就扯到正题了，对的，此法宝自带安全验证功能，类似我们今天的密码校验与<strong>指纹识别验证</strong>功能。</p>
<h3 id="指纹识别简析"><a href="#指纹识别简析" class="headerlink" title="指纹识别简析"></a>指纹识别简析</h3><p>苹果设计的iOS是以安全性为核心的，不管是沙盒机制，还是代码签名等，他们的最终目的都是为了安全。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/949086-05026b5044ba62e9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/300" alt="iOS 安全架构图"></p>
<p>自iPhone 5S始，苹果公司推出了全新生物安全识别技术—指纹识别验证（Touch ID）。使得我们可以更快、更轻松地对设备进行安全的访问。可贵的是，Touch ID做到了从任意角度读取指纹数据，克服了基于密码进行锁定的不便。除此之外，苹果还加入必须进行密码校验的场景，进一步确保安全，例如【1】:</p>
<ul>
<li>刚开机或重启；</li>
<li>超过 48 小时未解锁设备；</li>
<li>设备收到了远程锁定命令；</li>
<li>五次未能成功匹配指纹；</li>
<li>进入Touch ID设置模块或更新新指纹；</li>
</ul>
<p>最重要的一点，苹果公司提供Touch ID给第三方应用程序使用，程序只会收到认证是否成功的通知，而无法访问 Touch ID 或与已注册指纹相关的数据，这一点对安全而言尤为重要。</p>
<p>为了获得更高的安全性，很多银行类、支付类APP都集成了指纹、手势等二次验证功能。今天我们就重点来谈谈Touch ID集成到APP的具体流程及实现。</p>
<h3 id="流程分析"><a href="#流程分析" class="headerlink" title="流程分析"></a>流程分析</h3><p><strong>指纹登录流程：</strong><br><img src="http://upload-images.jianshu.io/upload_images/949086-dd8751e1eabc6521.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/960" alt="首次登录.png"><br><strong>二次启动后识别登录：</strong><br><img src="http://upload-images.jianshu.io/upload_images/949086-1a291c4684c42ac3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/960" alt="指纹验证登录.png"></p>
<p>使用过指纹登录的朋友，大概都知道上面的流程。<br>这个业务实现的难点在于，首次登录成功并启用指纹授权<strong>—&gt;</strong>退出APP后<strong>—&gt;</strong>二次启动APP，如何判断是否要启用指纹登录验证呢？这时就需要我们对数据持久化和数据共享有较深的理解，很多APP开发者，在开发<strong>登录保持</strong>的时候，大都会使用持久化数据的方式，存储<strong>成功登录</strong>的标记。但对于安全性较高的APP，每次重新启动时都会校验登录状态，单靠持久化数据是不够的。</p>
<p><strong>我的解决方案是：</strong><br>通过三个数据进行<strong>登录保持</strong>，</p>
<ul>
<li>loginState：持久化数据，用于存储用户登录成功，未激活状态；</li>
<li>startAutoLoginState：持久化数据，是否开启指纹识别授权；</li>
<li>isAppCurrentLoginState：共享数据，登录激活状态，该状态的特点，每次重新启动APP都会重新初始化数据。</li>
</ul>
<h5 id="首次登录："><a href="#首次登录：" class="headerlink" title="首次登录："></a>首次登录：</h5><p>三个数据变化情况，</p>
<table>
<thead>
<tr>
<th style="text-align:center">状态</th>
<th style="text-align:center">loginState</th>
<th style="text-align:center">startAutoLoginState</th>
<th style="text-align:center">isAppCurrentLoginState</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">登录之前</td>
<td style="text-align:center">nil或NO</td>
<td style="text-align:center">nil或NO</td>
<td style="text-align:center">NO</td>
</tr>
<tr>
<td style="text-align:center">登录成功</td>
<td style="text-align:center">YES</td>
<td style="text-align:center">nil或NO</td>
<td style="text-align:center">YES</td>
</tr>
<tr>
<td style="text-align:center">启用指纹授权</td>
<td style="text-align:center">YES</td>
<td style="text-align:center">YES</td>
<td style="text-align:center">YES</td>
</tr>
<tr>
<td style="text-align:center">不启用授权</td>
<td style="text-align:center">YES</td>
<td style="text-align:center">NO</td>
<td style="text-align:center">YES</td>
</tr>
</tbody>
</table>
<h5 id="二次验证登录（指纹登录）："><a href="#二次验证登录（指纹登录）：" class="headerlink" title="二次验证登录（指纹登录）："></a>二次验证登录（指纹登录）：</h5><p>三个数据变化情况，</p>
<ul>
<li>如果loginState和startAutoLoginState同为YES，即可进行指纹登录验证，以下为数据变化情况；</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:center">状态</th>
<th style="text-align:center">loginState</th>
<th style="text-align:center">startAutoLoginState</th>
<th style="text-align:center">isAppCurrentLoginState</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">验证之前</td>
<td style="text-align:center">YES</td>
<td style="text-align:center">YES</td>
<td style="text-align:center">NO</td>
</tr>
<tr>
<td style="text-align:center">验证失败</td>
<td style="text-align:center">NO</td>
<td style="text-align:center">YES</td>
<td style="text-align:center">NO</td>
</tr>
<tr>
<td style="text-align:center">验证成功</td>
<td style="text-align:center">YES</td>
<td style="text-align:center">YES</td>
<td style="text-align:center">YES</td>
</tr>
</tbody>
</table>
<ul>
<li>否则，重新登录。</li>
</ul>
<h3 id="核心代码实现"><a href="#核心代码实现" class="headerlink" title="核心代码实现"></a>核心代码实现</h3><p>判断设备是否支持指纹识别<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * 判断设备是否支持指纹识别</div><div class="line"> */</div><div class="line">- (IBAction)loginBtnAction:(UIButton *)sender</div><div class="line">&#123;</div><div class="line"></div><div class="line">    [[NSUserDefaults standardUserDefaults] setObject:[NSNumber numberWithBool:YES] forKey:@&quot;loginState&quot;];</div><div class="line"></div><div class="line">    EVNHelper *helper = [EVNHelper shareHelper];</div><div class="line">    helper.isAppCurrentLoginState = YES;</div><div class="line"></div><div class="line">    LAContext *context = [[LAContext alloc] init]; // 初始化上下文对象</div><div class="line">    NSError *error = nil;</div><div class="line">    // 判断设备是否支持指纹识别功能</div><div class="line">    if ([context canEvaluatePolicy:LAPolicyDeviceOwnerAuthenticationWithBiometrics error:&amp;error])</div><div class="line">    &#123;</div><div class="line">        // 支持指纹验证</div><div class="line">        UIAlertController *alertController = [UIAlertController alertControllerWithTitle:@&quot;登录成功！&quot; message:@&quot;是否启用指纹登录&quot; preferredStyle:UIAlertControllerStyleAlert];</div><div class="line"></div><div class="line">        __weak typeof (self) weakSelf = self;</div><div class="line"></div><div class="line">        UIAlertAction *cancelAction = [UIAlertAction actionWithTitle:@&quot;稍后&quot; style:UIAlertActionStyleCancel handler:^(UIAlertAction * _Nonnull action) &#123;</div><div class="line"></div><div class="line">            [[NSUserDefaults standardUserDefaults] setObject:[NSNumber numberWithBool:NO] forKey:@&quot;startAutoLoginState&quot;];</div><div class="line">            weakSelf.transLoginStateBlock(); // 回传</div><div class="line">            [self dismissViewControllerAnimated:YES completion:nil];</div><div class="line">        &#125;];</div><div class="line"></div><div class="line">        UIAlertAction *startUseAction = [UIAlertAction actionWithTitle:@&quot;启用&quot; style:UIAlertActionStyleDestructive handler:^(UIAlertAction * _Nonnull action) &#123;</div><div class="line"></div><div class="line">            [[NSUserDefaults standardUserDefaults] setObject:[NSNumber numberWithBool:YES] forKey:@&quot;startAutoLoginState&quot;];</div><div class="line">            weakSelf.transLoginStateBlock(); // 回传</div><div class="line">            [self dismissViewControllerAnimated:YES completion:nil];</div><div class="line"></div><div class="line">        &#125;];</div><div class="line">        [alertController addAction:cancelAction];</div><div class="line">        [alertController addAction:startUseAction];</div><div class="line">        </div><div class="line">        [self presentViewController:alertController animated:YES completion:nil];</div><div class="line">    &#125;</div><div class="line">    else</div><div class="line">    &#123;</div><div class="line">        [[NSUserDefaults standardUserDefaults] setObject:[NSNumber numberWithBool:NO] forKey:@&quot;startAutoLoginState&quot;];</div><div class="line">        self.transLoginStateBlock(); // 回传</div><div class="line">        [self dismissViewControllerAnimated:YES completion:nil];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>指纹登录验证<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * 指纹登录验证</div><div class="line"> */</div><div class="line">- (void)loadAuthentication</div><div class="line">&#123;</div><div class="line">    __weak typeof(self) weakSelf = self;</div><div class="line"></div><div class="line">    LAContext *myContext = [[LAContext alloc] init];</div><div class="line">    // 这个属性是设置指纹输入失败之后的弹出框的选项</div><div class="line">    myContext.localizedFallbackTitle = @&quot;忘记密码&quot;;</div><div class="line"></div><div class="line">    NSError *authError = nil;</div><div class="line">    NSString *myLocalizedReasonString = @&quot;请按住Home键完成验证&quot;;</div><div class="line">    // MARK: 判断设备是否支持指纹识别</div><div class="line">    if ([myContext canEvaluatePolicy:LAPolicyDeviceOwnerAuthenticationWithBiometrics error:&amp;authError])</div><div class="line">    &#123;</div><div class="line">        [myContext evaluatePolicy:LAPolicyDeviceOwnerAuthenticationWithBiometrics localizedReason:myLocalizedReasonString reply:^(BOOL success, NSError * _Nullable error) &#123;</div><div class="line">            if(success)</div><div class="line">            &#123;</div><div class="line">                NSLog(@&quot;指纹认证成功&quot;);</div><div class="line"></div><div class="line">                weakSelf.helper.isAppCurrentLoginState = YES;</div><div class="line"></div><div class="line">                weakSelf.logoutBtnAction.hidden = NO;</div><div class="line">                weakSelf.userInfo.text = @&quot;仁伯安&quot;;</div><div class="line">            &#125;</div><div class="line">            else</div><div class="line">            &#123;</div><div class="line">                weakSelf.helper.isAppCurrentLoginState = NO;</div><div class="line">                NSLog(@&quot;指纹认证失败，%@&quot;,error.description);</div><div class="line"></div><div class="line">                NSLog(@&quot;%ld&quot;, (long)error.code); // 错误码 error.code</div><div class="line">                switch (error.code)</div><div class="line">                &#123;</div><div class="line">                    case LAErrorAuthenticationFailed: // Authentication was not successful, because user failed to provide valid credentials</div><div class="line">                    &#123;</div><div class="line">                        NSLog(@&quot;授权失败&quot;); // -1 连续三次指纹识别错误</div><div class="line">                    &#125;</div><div class="line">                        break;</div><div class="line">                    case LAErrorUserCancel: // Authentication was canceled by user (e.g. tapped Cancel button)</div><div class="line">                    &#123;</div><div class="line">                        NSLog(@&quot;用户取消验证Touch ID&quot;); // -2 在TouchID对话框中点击了取消按钮</div><div class="line"></div><div class="line">                    &#125;</div><div class="line">                        break;</div><div class="line">                    case LAErrorUserFallback: // Authentication was canceled, because the user tapped the fallback button (Enter Password)</div><div class="line">                    &#123;</div><div class="line">                        [[NSOperationQueue mainQueue] addOperationWithBlock:^&#123;</div><div class="line">                            NSLog(@&quot;用户选择输入密码，切换主线程处理&quot;); // -3 在TouchID对话框中点击了输入密码按钮</div><div class="line">                        &#125;];</div><div class="line"></div><div class="line">                    &#125;</div><div class="line">                        break;</div><div class="line">                    case LAErrorSystemCancel: // Authentication was canceled by system (e.g. another application went to foreground)</div><div class="line">                    &#123;</div><div class="line">                        NSLog(@&quot;取消授权，如其他应用切入，用户自主&quot;); // -4 TouchID对话框被系统取消，例如按下Home或者电源键</div><div class="line">                    &#125;</div><div class="line">                        break;</div><div class="line">                    case LAErrorPasscodeNotSet: // Authentication could not start, because passcode is not set on the device.</div><div class="line"></div><div class="line">                    &#123;</div><div class="line">                        NSLog(@&quot;设备系统未设置密码&quot;); // -5</div><div class="line">                    &#125;</div><div class="line">                        break;</div><div class="line">                    case LAErrorTouchIDNotAvailable: // Authentication could not start, because Touch ID is not available on the device</div><div class="line">                    &#123;</div><div class="line">                        NSLog(@&quot;设备未设置Touch ID&quot;); // -6</div><div class="line">                    &#125;</div><div class="line">                        break;</div><div class="line">                    case LAErrorTouchIDNotEnrolled: // Authentication could not start, because Touch ID has no enrolled fingers</div><div class="line">                    &#123;</div><div class="line">                        NSLog(@&quot;用户未录入指纹&quot;); // -7</div><div class="line">                    &#125;</div><div class="line">                        break;</div><div class="line"></div><div class="line">#if __IPHONE_OS_VERSION_MAX_ALLOWED &gt;= __IPHONE_9_0</div><div class="line">                    case LAErrorTouchIDLockout: //Authentication was not successful, because there were too many failed Touch ID attempts and Touch ID is now locked. Passcode is required to unlock Touch ID, e.g. evaluating LAPolicyDeviceOwnerAuthenticationWithBiometrics will ask for passcode as a prerequisite 用户连续多次进行Touch ID验证失败，Touch ID被锁，需要用户输入密码解锁，先Touch ID验证密码</div><div class="line">                    &#123;</div><div class="line">                        NSLog(@&quot;Touch ID被锁，需要用户输入密码解锁&quot;); // -8 连续五次指纹识别错误，TouchID功能被锁定，下一次需要输入系统密码</div><div class="line">                    &#125;</div><div class="line">                        break;</div><div class="line">                    case LAErrorAppCancel: // Authentication was canceled by application (e.g. invalidate was called while authentication was in progress) 如突然来了电话，电话应用进入前台，APP被挂起啦&quot;);</div><div class="line">                    &#123;</div><div class="line">                        NSLog(@&quot;用户不能控制情况下APP被挂起&quot;); // -9</div><div class="line">                    &#125;</div><div class="line">                        break;</div><div class="line">                    case LAErrorInvalidContext: // LAContext passed to this call has been previously invalidated.</div><div class="line">                    &#123;</div><div class="line">                        NSLog(@&quot;LAContext传递给这个调用之前已经失效&quot;); // -10</div><div class="line">                    &#125;</div><div class="line">                        break;</div><div class="line">#else</div><div class="line">#endif</div><div class="line">                    default:</div><div class="line">                    &#123;</div><div class="line">                        [[NSOperationQueue mainQueue] addOperationWithBlock:^&#123;</div><div class="line">                            NSLog(@&quot;其他情况，切换主线程处理&quot;);</div><div class="line">                        &#125;];</div><div class="line">                        break;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;];</div><div class="line">    &#125;</div><div class="line">    else</div><div class="line">    &#123;</div><div class="line">        NSLog(@&quot;设备不支持指纹&quot;);</div><div class="line">        NSLog(@&quot;%ld&quot;, (long)authError.code);</div><div class="line">        weakSelf.helper.isAppCurrentLoginState = NO;</div><div class="line">        switch (authError.code)</div><div class="line">        &#123;</div><div class="line">            case LAErrorTouchIDNotEnrolled:</div><div class="line">            &#123;</div><div class="line">                NSLog(@&quot;Authentication could not start, because Touch ID has no enrolled fingers&quot;);</div><div class="line">                break;</div><div class="line">            &#125;</div><div class="line">            case LAErrorPasscodeNotSet:</div><div class="line">            &#123;</div><div class="line">                NSLog(@&quot;Authentication could not start, because passcode is not set on the device&quot;);</div><div class="line">                break;</div><div class="line">            &#125;</div><div class="line">            default:</div><div class="line">            &#123;</div><div class="line">                NSLog(@&quot;TouchID not available&quot;);</div><div class="line">                break;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>大致效果：<br><img src="http://upload-images.jianshu.io/upload_images/949086-d8e74f9da26c355e.gif?imageMogr2/auto-orient/strip%7CimageView2/2/w/333" alt="录屏图.gif"><br>Demo GitHub下载链接: <a href="https://github.com/zonghongyan/EVNTouchIDDemo.git" target="_blank" rel="external">EVNTouchIDDemo.git</a>，如果有用，给个Star……</p>
<p><strong>参考文献：</strong><br>【1】<a href="http://www.documentcloud.org/documents/1302613-ios-security-guide-sept-2014.html" target="_blank" rel="external">iOS security guide</a>;<br>【2】<a href="https://developer.apple.com/reference/localauthentication?language=objc" target="_blank" rel="external">Apple Objective-C</a>;<br>【3】<a href="https://developer.apple.com/reference/localauthentication" target="_blank" rel="external">Apple Swift API</a>.</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Objective-C/" rel="tag"># Objective-C</a>
          
            <a href="/tags/Demo/" rel="tag"># Demo</a>
          
            <a href="/tags/Touch-ID/" rel="tag"># Touch ID</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/10/13/201610131932/" rel="next" title="Swift和Objective-C混编的注意啦">
                <i class="fa fa-chevron-left"></i> Swift和Objective-C混编的注意啦
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/12/23/201612230912/" rel="prev" title="苹果APP接入HTTPS延迟截止时间是妥协吗">
                苹果APP接入HTTPS延迟截止时间是妥协吗 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
       
         <div id="gitment-container"></div>
       
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar/avatar-60.png"
               alt="仁伯安" />
          <p class="site-author-name" itemprop="name">仁伯安</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">13</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">16</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/zonghongyan" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.jianshu.com/u/ac49bc773ff9" target="_blank" title="简书">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  简书
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://twitter.com/zonghongyan" target="_blank" title="Twitter">
                  
                    <i class="fa fa-fw fa-twitter"></i>
                  
                  Twitter
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-block">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              友情链接
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="https://yangkaik.github.io" title="yangkaik" target="_blank">yangkaik</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.jianshu.com/u/ac49bc773ff9" title="仁伯安简书" target="_blank">仁伯安简书</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://gold.xitu.io/user/58a17f6c8d6d81006ca065e7" title="掘金" target="_blank">掘金</a>
                </li>
              
                <li class="links-of-blogroll-item">
                  <a href="https://developer.apple.com" title="apple开发者" target="_blank">apple开发者</a>
                </li>
              
            </ul>
          </div>
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#闲谈"><span class="nav-number">1.</span> <span class="nav-text">闲谈</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#指纹识别简析"><span class="nav-number">2.</span> <span class="nav-text">指纹识别简析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#流程分析"><span class="nav-number">3.</span> <span class="nav-text">流程分析</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#首次登录："><span class="nav-number">3.0.1.</span> <span class="nav-text">首次登录：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#二次验证登录（指纹登录）："><span class="nav-number">3.0.2.</span> <span class="nav-text">二次验证登录（指纹登录）：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#核心代码实现"><span class="nav-number">4.</span> <span class="nav-text">核心代码实现</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">仁伯安</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  

  
</div>


        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






     
     
     
     
     <link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
     <script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
     
         <script type="text/javascript">
             var gitment = new Gitment({
                id: document.location.href, 
                 owner: 'zonghongyan',
                 repo: 'zonghongyan.github.io',
                 oauth: {
                     client_id: '8bb735003260a23ded3d',
                     client_secret: 'a882b3feb6e36ae4f367fe601615f6d1b7f1a232',
                 }});
             gitment.render('gitment-container');
         </script>
     
 

  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  

  

  

</body>
</html>
